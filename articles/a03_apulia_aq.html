<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Analysis of Apulia Air Quality Data • STDGLM</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<!-- katex math --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script><script src="../katex-auto.js"></script><script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Analysis of Apulia Air Quality Data">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">STDGLM</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/STDGLM.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/a01_model_output.html">Details on Model Output</a></li>
    <li><a class="dropdown-item" href="../articles/a02_fit_simulated.html">Simulated Data Analysis</a></li>
    <li><a class="dropdown-item" href="../articles/a03_apulia_aq.html">Analysis of Apulia Air Quality Data</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/czaccard/STDGLM/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Analysis of Apulia Air Quality Data</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/czaccard/STDGLM/blob/main/vignettes/articles/a03_apulia_aq.Rmd" class="external-link"><code>vignettes/articles/a03_apulia_aq.Rmd</code></a></small>
      <div class="d-none name"><code>a03_apulia_aq.Rmd</code></div>
    </div>

    
    
<p>Here, we will analyze a real application. The dataset
<code>ApuliaAQ</code>, included within the package, contains daily
measurements of some air pollutant concentrations from ground monitoring
stations located in Apulia, Italy, from June to December 2022. In
particular, we want to predict the nitrogen dioxide (NO2)
concentrations. This example is relevant to demonstrate how the
<code><a href="../reference/stdglm.html">stdglm()</a></code> function works when there are missing data in the
response variable.</p>
<p>As usual, we start by loading the required packages.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/czaccard/STDGLM" class="external-link">STDGLM</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">packages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"dplyr"</span>, <span class="st">"ggplot2"</span>, <span class="st">"tidyr"</span>, <span class="st">"ggpubr"</span>, <span class="st">"coda"</span>, <span class="st">"sf"</span>, <span class="st">"abind"</span>, <span class="st">"units"</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">package</span> <span class="kw">in</span> <span class="va">packages</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va">package</span>, character.only <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="va">package</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va">package</span>, character.only <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Loading required package: dplyr</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span>
<span><span class="co">#&gt; Loading required package: ggplot2</span></span>
<span><span class="co">#&gt; Loading required package: tidyr</span></span>
<span><span class="co">#&gt; Loading required package: ggpubr</span></span>
<span><span class="co">#&gt; Loading required package: coda</span></span>
<span><span class="co">#&gt; Loading required package: sf</span></span>
<span><span class="co">#&gt; Linking to GEOS 3.12.1, GDAL 3.8.4, PROJ 9.4.0; sf_use_s2() is TRUE</span></span>
<span><span class="co">#&gt; Loading required package: abind</span></span>
<span><span class="co">#&gt; Loading required package: units</span></span>
<span><span class="co">#&gt; udunits database from /usr/share/xml/udunits/udunits2.xml</span></span></code></pre></div>
<div class="section level2">
<h2 id="data-preparation">Data Preparation<a class="anchor" aria-label="anchor" href="#data-preparation"></a>
</h2>
<p>The data can be loaded using the following command. The definition of
each column can be found at this <a href="https://doi.org/10.5281/zenodo.15699805" class="external-link">link</a>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># load data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">ApuliaAQ</span><span class="op">)</span></span>
<span><span class="va">ApuliaAQ</span> <span class="op">=</span> <span class="va">ApuliaAQ</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time</span><span class="op">&gt;=</span><span class="st">'2022-06-01'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">ApuliaAQ</span><span class="op">)</span></span>
<span><span class="co">#&gt;   AirQualityStation       time Longitude Latitude Altitude</span></span>
<span><span class="co">#&gt; 1       STA.IT1953A 2022-06-01  18.17361 40.16805       50</span></span>
<span><span class="co">#&gt; 2       STA.IT1687A 2022-06-01  18.09507 40.34627       10</span></span>
<span><span class="co">#&gt; 3       STA.IT2044A 2022-06-01  18.17667 40.35194       50</span></span>
<span><span class="co">#&gt; 4       STA.IT1932A 2022-06-01  18.17306 40.36444       58</span></span>
<span><span class="co">#&gt; 5       STA.IT2150A 2022-06-01  18.12500 40.40333      100</span></span>
<span><span class="co">#&gt; 6       STA.IT1666A 2022-06-01  18.02972 40.40444       10</span></span>
<span><span class="co">#&gt;   AirQualityStationType AirQualityStationArea AQ_mean_NO2 AQ_mean_PM10</span></span>
<span><span class="co">#&gt; 1            industrial              suburban    9.165000           NA</span></span>
<span><span class="co">#&gt; 2            background              suburban          NA     23.40000</span></span>
<span><span class="co">#&gt; 3               traffic                 urban   15.396875     29.40000</span></span>
<span><span class="co">#&gt; 4               traffic                 urban    6.584167     24.00000</span></span>
<span><span class="co">#&gt; 5            background                 rural   11.384167     25.70104</span></span>
<span><span class="co">#&gt; 6            background              suburban   15.330625     29.60000</span></span>
<span><span class="co">#&gt;   AQ_mean_PM2.5   CL_blh CL_lai_hv CL_lai_lv    CL_rh  CL_ssr   CL_t2m CL_tp</span></span>
<span><span class="co">#&gt; 1           9.4 375.9880  1.728394  2.132446 70.08264 3099264 24.84413     0</span></span>
<span><span class="co">#&gt; 2            NA 616.1546  1.047241  2.083252 67.86420 2982720 25.06085     0</span></span>
<span><span class="co">#&gt; 3          12.5 375.9880  1.728394  2.132446 70.08264 3099264 24.84413     0</span></span>
<span><span class="co">#&gt; 4           8.5 375.9880  1.728394  2.132446 70.08264 3099264 24.84413     0</span></span>
<span><span class="co">#&gt; 5            NA 544.1208  1.984253  2.900024 64.76970 2982912 25.43316     0</span></span>
<span><span class="co">#&gt; 6           4.7 544.1208  1.984253  2.900024 64.76970 2982912 25.43316     0</span></span>
<span><span class="co">#&gt;   CL_winddir CL_windspeed</span></span>
<span><span class="co">#&gt; 1          1     2.528502</span></span>
<span><span class="co">#&gt; 2          1     2.261226</span></span>
<span><span class="co">#&gt; 3          1     2.528502</span></span>
<span><span class="co">#&gt; 4          1     2.528502</span></span>
<span><span class="co">#&gt; 5          1     2.855337</span></span>
<span><span class="co">#&gt; 6          1     2.855337</span></span></code></pre></div>
<p>Next, we download the shapefile of Apulia region to create some
maps.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="st">"confiniregionali.zip"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span></span>
<span>    <span class="st">"https://dati.puglia.it/ckan/dataset/9e105292-26d3-49b3-ae2c-e19a987886bc/resource/212e8004-5af4-467f-b910-1183bdc21730/download/confiniregionali.zip"</span>,</span>
<span>    destfile <span class="op">=</span> <span class="st">"confiniregionali.zip"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">apulia_sf</span> <span class="op">=</span> <span class="fu">st_read</span><span class="op">(</span><span class="st">"/vsizip/confiniregionali.zip/ConfiniRegionali/"</span>, layer <span class="op">=</span> <span class="st">"ConfiniRegionali"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Reading layer `ConfiniRegionali' from data source </span></span>
<span><span class="co">#&gt;   `/vsizip/confiniregionali.zip/ConfiniRegionali/' using driver `ESRI Shapefile'</span></span>
<span><span class="co">#&gt; Simple feature collection with 1 feature and 3 fields</span></span>
<span><span class="co">#&gt; Geometry type: MULTIPOLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 494422.8 ymin: 4409765 xmax: 800058.5 ymax: 4675192</span></span>
<span><span class="co">#&gt; Projected CRS: WGS 84 / UTM zone 33N</span></span></code></pre></div>
<p>Note that <code>apulia_sf</code> uses a Universal Transverse Mercator
(UTM) projection, given by EPSG code 32633, where the coordinates are
defined in meters. However, it is more convenient to convert them to
kilometers, as follows. We also convert the <code>ApuliaAQ</code>
dataframe to a simple feature object.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">projUTM</span> <span class="op">=</span> <span class="st">"+proj=utm +zone=33 +datum=WGS84 +units=km +no_defs"</span></span>
<span><span class="va">apulia_sf</span> <span class="op">=</span> <span class="fu">st_transform</span><span class="op">(</span><span class="va">apulia_sf</span>, <span class="va">projUTM</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="va">ApuliaAQ</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">st_as_sf</span><span class="op">(</span>coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Longitude'</span>, <span class="st">'Latitude'</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">st_transform</span><span class="op">(</span><span class="va">projUTM</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="spatial-locations-for-interpolation">Spatial Locations for Interpolation<a class="anchor" aria-label="anchor" href="#spatial-locations-for-interpolation"></a>
</h3>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st_new</span> <span class="op">=</span> <span class="fu">st_make_grid</span><span class="op">(</span><span class="va">apulia_sf</span>, what <span class="op">=</span> <span class="st">"centers"</span>, cellsize <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">st_intersection</span><span class="op">(</span><span class="va">apulia_sf</span><span class="op">)</span></span>
<span><span class="va">p_new</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NROW</a></span><span class="op">(</span><span class="va">st_new</span><span class="op">)</span></span>
<span><span class="va">h_ahead</span> <span class="op">=</span> <span class="fl">0</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="exploratory-analysis">Exploratory Analysis<a class="anchor" aria-label="anchor" href="#exploratory-analysis"></a>
</h2>
<p>A first exploratory tool is a map of the yearly average NO2
concentrations.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">yearly_avg</span> <span class="op">=</span> <span class="va">data</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">AirQualityStation</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarise</span><span class="op">(</span>AQ_mean_NO2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">AQ_mean_NO2</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span>,</span>
<span>            AirQualityStation <span class="op">=</span> <span class="fu">first</span><span class="op">(</span><span class="va">AirQualityStation</span><span class="op">)</span>,</span>
<span>            AirQualityStationType <span class="op">=</span> <span class="fu">first</span><span class="op">(</span><span class="va">AirQualityStationType</span><span class="op">)</span>,</span>
<span>    .groups <span class="op">=</span> <span class="st">'drop'</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">apulia_sf</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>col <span class="op">=</span> <span class="va">AQ_mean_NO2</span>, shape <span class="op">=</span> <span class="va">AirQualityStationType</span><span class="op">)</span>, <span class="va">yearly_avg</span>, size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_viridis_c</span><span class="op">(</span>na.value <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"2022 average NO2 concentrations"</span><span class="op">)</span></span></code></pre></div>
<p><img src="a03_apulia_aq_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<p>The red points pinpoint those stations without any valid measurement.
However, the percentage of missing data is highly variable across
stations.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">perc_na</span> <span class="op">=</span> <span class="va">data</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">AirQualityStation</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarise</span><span class="op">(</span>Percentage <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">AQ_mean_NO2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            AirQualityStation <span class="op">=</span> <span class="fu">first</span><span class="op">(</span><span class="va">AirQualityStation</span><span class="op">)</span>,</span>
<span>    .groups <span class="op">=</span> <span class="st">'drop'</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">perc_na</span><span class="op">$</span><span class="va">Percentage</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#&gt; 0.04206 0.06776 0.08411 0.13478 0.12850 1.00000</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">apulia_sf</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>col <span class="op">=</span> <span class="va">Percentage</span><span class="op">)</span>, <span class="va">perc_na</span>, size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_viridis_c</span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Percentage of missing data"</span><span class="op">)</span></span></code></pre></div>
<p><img src="a03_apulia_aq_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<p>Let’s now visualize the data temporally, by taking the average across
space.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">space_avg</span> <span class="op">=</span> <span class="va">ApuliaAQ</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">time</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarise</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu">where</span><span class="op">(</span><span class="va">is.numeric</span><span class="op">)</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">.x</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    .groups <span class="op">=</span> <span class="st">'drop'</span><span class="op">)</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">space_avg</span>, <span class="fu">aes</span><span class="op">(</span><span class="va">time</span>, <span class="va">AQ_mean_NO2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">'none'</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Removed 1 row containing missing values or values outside the scale range</span></span>
<span><span class="co">#&gt; (`geom_line()`).</span></span></code></pre></div>
<p><img src="a03_apulia_aq_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<p>In the figure above, there are small gaps indicating that there are
no data for some days.</p>
<p>Missing observations in the response are not an issue when fitting
the model, since <code>NA</code> values will be estimated using the
posterior predictive distribution.</p>
<p><strong>Important</strong>: the <code>stdglm</code> function
<em>does</em> handle missing data in the response, but not in the
covariates!</p>
</div>
<div class="section level2">
<h2 id="model-fitting">Model Fitting<a class="anchor" aria-label="anchor" href="#model-fitting"></a>
</h2>
<p>For the purpose of the illustration, we assume that the NO2
concentrations follows a Gaussian distribution where the mean is a
simple linear spatio-temporal trend, and the variance has a separable
spatio-temporal structure (with exponential spatial correlation
function, and AR(1) temporal dependence).</p>
<p>Before actually fitting the model, some preliminaries are required to
organize the data in the correct form.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">AirQualityStation</span><span class="op">)</span><span class="op">)</span> <span class="co"># 51</span></span>
<span><span class="va">t</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">time</span><span class="op">)</span><span class="op">)</span>              <span class="co"># 365</span></span>
<span><span class="va">times</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">time</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># distance matrix</span></span>
<span><span class="va">D</span> <span class="op">=</span> <span class="fu">drop_units</span><span class="op">(</span><span class="fu">st_distance</span><span class="op">(</span><span class="va">yearly_avg</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># response variable (log scale)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">AQ_mean_NO2</span><span class="op">)</span><span class="op">)</span>, <span class="va">p</span>, <span class="va">t</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># covariates</span></span>
<span><span class="va">X</span> <span class="op">=</span> <span class="fu">abind</span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">p</span>, <span class="va">t</span><span class="op">)</span>,</span>
<span>  along <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span> <span class="co"># NA's are not allowed here!</span></span>
<span><span class="co">#&gt; integer(0)</span></span>
<span></span>
<span><span class="va">Z</span> <span class="op">=</span> <span class="fu">abind</span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu">st_coordinates</span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">/</span><span class="fl">1e3</span>, <span class="va">p</span>, <span class="va">t</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu">st_coordinates</span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">/</span><span class="fl">1e3</span>, <span class="va">p</span>, <span class="va">t</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="op">(</span><span class="fu">st_coordinates</span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">/</span><span class="fl">1e3</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span>, <span class="va">p</span>, <span class="va">t</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="op">(</span><span class="fu">st_coordinates</span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">/</span><span class="fl">1e3</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span>, <span class="va">p</span>, <span class="va">t</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">time</span><span class="op">)</span><span class="op">/</span><span class="fl">2e4</span>, <span class="va">p</span>, <span class="va">t</span><span class="op">)</span>,</span>
<span>  along <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">Z</span><span class="op">)</span><span class="op">)</span> <span class="co"># NA's are not allowed here!</span></span>
<span><span class="co">#&gt; integer(0)</span></span>
<span></span>
<span><span class="co"># # covariates</span></span>
<span><span class="co"># X = abind(</span></span>
<span><span class="co">#   matrix(1, p, t), </span></span>
<span><span class="co">#   matrix(scale(data$CL_t2m), p, t),</span></span>
<span><span class="co">#   matrix(scale(data$CL_windspeed), p, t),</span></span>
<span><span class="co">#   matrix(scale(data$CL_ssr), p, t),</span></span>
<span><span class="co">#   matrix(scale(data$CL_blh), p, t),</span></span>
<span><span class="co">#   along = 3)</span></span>
<span><span class="co"># which(is.na(X)) # NA's are not allowed here!</span></span>
<span></span>
<span><span class="co"># Z = model.matrix(~AirQualityStationType, data)[,-1, drop=FALSE] # types industrial and traffic wrt backgroud</span></span>
<span><span class="co"># dim(Z) = c(p, t, NCOL(Z)) # reshape in the correct way</span></span>
<span><span class="co"># Z = abind(Z,</span></span>
<span><span class="co">#   matrix(scale(data$Altitude), p, t),</span></span>
<span><span class="co">#   matrix(scale(as.numeric(data$time)), p, t),</span></span>
<span><span class="co">#   along = 3)</span></span>
<span><span class="co"># which(is.na(Z)) # NA's are not allowed here!</span></span></code></pre></div>
<p>The creation of some object for spatial interpolation is also
required, as shown below.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ii</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">p_new</span><span class="op">+</span><span class="fl">1</span>, by <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">lii</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ii</span><span class="op">)</span></span>
<span></span>
<span><span class="va">D_pred</span> <span class="op">=</span> <span class="va">D_cross</span> <span class="op">=</span> <span class="va">blocks_indices</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span><span class="st">'list'</span>, <span class="va">lii</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="va">lii</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">Dalltemp</span> <span class="op">=</span> <span class="fu">drop_units</span><span class="op">(</span><span class="fu">st_distance</span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu">st_geometry</span><span class="op">(</span><span class="va">yearly_avg</span><span class="op">)</span>, <span class="fu">st_geometry</span><span class="op">(</span><span class="va">st_new</span><span class="op">[</span><span class="va">ii</span><span class="op">[</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">:</span><span class="op">(</span><span class="va">ii</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="va">D_pred</span><span class="op">[[</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="va">Dalltemp</span><span class="op">[</span><span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">p</span><span class="op">)</span>, <span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">p</span><span class="op">)</span>, drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">D_cross</span><span class="op">[[</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="va">Dalltemp</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">p</span>, <span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">p</span><span class="op">)</span>, drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">blocks_indices</span><span class="op">[[</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="va">ii</span><span class="op">[</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">:</span><span class="op">(</span><span class="va">ii</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">Xpred</span> <span class="op">=</span> <span class="fu">abind</span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">p_new</span>, <span class="va">t</span><span class="op">)</span>,</span>
<span>  along <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Zpred</span> <span class="op">=</span> <span class="fu">abind</span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu">st_coordinates</span><span class="op">(</span><span class="va">st_new</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">/</span><span class="fl">1e3</span>, <span class="va">p_new</span>, <span class="va">t</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu">st_coordinates</span><span class="op">(</span><span class="va">st_new</span><span class="op">)</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">/</span><span class="fl">1e3</span>, <span class="va">p_new</span>, <span class="va">t</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="op">(</span><span class="fu">st_coordinates</span><span class="op">(</span><span class="va">st_new</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">/</span><span class="fl">1e3</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span>, <span class="va">p_new</span>, <span class="va">t</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="op">(</span><span class="fu">st_coordinates</span><span class="op">(</span><span class="va">st_new</span><span class="op">)</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">/</span><span class="fl">1e3</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span>, <span class="va">p_new</span>, <span class="va">t</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/outer.html" class="external-link">outer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">p_new</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">times</span><span class="op">)</span><span class="op">/</span><span class="fl">2e4</span><span class="op">)</span>,</span>
<span>  along <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set the total number of iterations</span></span>
<span><span class="va">nrep</span> <span class="op">&lt;-</span> <span class="fl">3000</span></span>
<span><span class="co"># Set the total number of burn-in iterations</span></span>
<span><span class="va">nburn</span> <span class="op">&lt;-</span> <span class="fl">3000</span></span>
<span><span class="co"># How many times to report progress</span></span>
<span><span class="va">print.interval</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span></span>
<span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stdglm.html">stdglm</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">y</span>, X<span class="op">=</span><span class="va">X</span>, Z<span class="op">=</span><span class="va">Z</span>,</span>
<span>              blocks_indices<span class="op">=</span><span class="va">blocks_indices</span>,</span>
<span>              W<span class="op">=</span><span class="va">D</span>, W_pred<span class="op">=</span><span class="va">D_pred</span>, W_cross<span class="op">=</span><span class="va">D_cross</span>,</span>
<span>              X_pred<span class="op">=</span><span class="va">Xpred</span>, Z_pred<span class="op">=</span><span class="va">Zpred</span>,</span>
<span>              interaction <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>              nrep <span class="op">=</span> <span class="va">nrep</span>, nburn <span class="op">=</span> <span class="va">nburn</span>, </span>
<span>              print.interval <span class="op">=</span> <span class="va">print.interval</span>,</span>
<span>              ncores <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">6</span><span class="op">)</span>, <span class="co"># Set number of cores for parallel processing</span></span>
<span>              keepLogLik <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="co"># to save memory</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="plotting-the-results">Plotting the Results<a class="anchor" aria-label="anchor" href="#plotting-the-results"></a>
</h2>
<p>To create maps of NO2 concentrations over Apulia, we can use the
<code>predict</code> method. Here, the posterior means are shown for
some selected days.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Y_pred</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">mod</span>, type <span class="op">=</span> <span class="st">'response_df'</span>, Coo_sf_pred <span class="op">=</span> <span class="fu">st_geometry</span><span class="op">(</span><span class="va">st_new</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mean_y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">AQ_mean_NO2</span><span class="op">)</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">sd_y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">AQ_mean_NO2</span><span class="op">)</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">Y_pred</span><span class="op">$</span><span class="va">NO2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">Y_pred</span><span class="op">$</span><span class="va">Mean</span><span class="op">*</span><span class="va">sd_y</span> <span class="op">+</span> <span class="va">mean_y</span><span class="op">)</span></span>
<span><span class="va">rr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">Y_pred</span><span class="op">$</span><span class="va">NO2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">gglist</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">ind</span> <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">50</span>, <span class="fl">100</span>, <span class="fl">130</span>, <span class="fl">170</span>, <span class="fl">200</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">gglist</span><span class="op">[[</span><span class="va">ind</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> </span>
<span>    <span class="fu">ggplot</span><span class="op">(</span><span class="va">Y_pred</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Time</span><span class="op">==</span><span class="va">i</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">apulia_sf</span>, fill <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">NO2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">scale_color_viridis_c</span><span class="op">(</span>limits<span class="op">=</span><span class="va">rr</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"NO2 Predictions, "</span>, <span class="va">times</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">ind</span> <span class="op">=</span> <span class="va">ind</span><span class="op">+</span><span class="fl">1</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">ggarrange</span><span class="op">(</span>plotlist<span class="op">=</span><span class="va">gglist</span>, ncol<span class="op">=</span><span class="fl">3</span>, nrow<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu">ggsave</span><span class="op">(</span><span class="st">"pred_no2_apulia.png"</span>, width <span class="op">=</span> <span class="fl">30</span>, height <span class="op">=</span> <span class="fl">20</span>, units <span class="op">=</span> <span class="st">"cm"</span><span class="op">)</span></span></code></pre></div>
<p><img src="pred_no2_apulia.png"><!-- --></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Carlo Zaccardi.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
